{% load i18n static %}
{% get_current_language as LANGUAGE_CODE %}
<nav class="navbar">
    <div class="navbar-links">
        <a href="{% url 'home' %}" class="nav-link{% if request.resolver_match.url_name == 'home' %} active{% endif %}">{% trans "Home" %}</a>
        <span class="nav-item-wrapper">
            <a href="{% url 'gallery' %}" class="nav-link{% if request.resolver_match.url_name == 'gallery' %} active{% endif %}">{% trans "Gallery" %}</a>
            <span class="coming-soon">{% trans "Coming Soon" %}</span>
        </span>
        <a href="{% url 'rsvp' %}" class="nav-link{% if request.resolver_match.url_name == 'rsvp' %} active{% endif %}">{% trans "RSVP" %}</a>
        <a href="{% url 'volunteer' %}" class="nav-link{% if request.resolver_match.url_name == 'volunteer' %} active{% endif %}">{% trans "Volunteer" %}</a>
        <span style="position:relative;display:inline-block;">
            <a href="{% url 'freebies' %}" class="nav-link{% if request.resolver_match.url_name == 'freebies' %} active{% endif %}">{% trans "Freebies" %}</a>
            <span class="for-you">{% trans "for you!" %}</span>
        </span>
    </div>
    <form action="{% url 'set_language' %}" method="post" class="lang-toggle">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.get_full_path }}">
        <button type="submit" name="language" value="en" class="lang-btn {% if LANGUAGE_CODE == 'en' %}active{% endif %}">EN</button>
        <button type="submit" name="language" value="zh-hans" class="lang-btn {% if LANGUAGE_CODE == 'zh-hans' %}active{% endif %}">ä¸­æ–‡</button>
    </form>
    <button id="speaker-btn" data-on="true" style="background:none; border:none; margin-left:16px; cursor:pointer; font-size:1.1em; display:flex; align-items:center;">
        <span id="speaker-icon" style="font-size:2.5rem;">ðŸ”Š</span>
        <span id="speaker-status" class="nav-link" style="margin-left:8px;">{% trans "On" %}</span>
    </button>
    <audio id="wedding-audio" preload="auto" autoplay playsinline loop src="{% static 'Christina Perri - A Thousand years - ThePianoGuys.mp3' %}"></audio>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var audio = document.getElementById('wedding-audio');
        var btn = document.getElementById('speaker-btn');
        var icon = document.getElementById('speaker-icon');
        var status = document.getElementById('speaker-status');
        // read saved audio on/off state (default on)
        var playOn = (localStorage.getItem('weddingAudioOn') !== 'false');
        // set mute based on preference and play
        audio.muted = !playOn;
        audio.play().catch(function(){});
        // set initial button UI based on playOn
        if (playOn) {
            btn.setAttribute('data-on', 'true');
            icon.textContent = 'ðŸ”Š';
            status.textContent = '{% trans "On" %}';
        } else {
            btn.setAttribute('data-on', 'false');
            icon.textContent = 'ðŸ”‡';
            status.textContent = '{% trans "Off" %}';
        }
        // function to restore playback position and play/pause
        function restorePlayback() {
            var savedTime = parseFloat(localStorage.getItem('weddingAudioTime') || 0);
            if (!isNaN(savedTime)) {
                audio.currentTime = savedTime;
            }
            if (playOn) {
                // unmute if previously unmuted by user
                audio.muted = false;
                audio.play().catch(function(){});
            } else {
                audio.pause();
            }
        }
        // restore after metadata loads or immediately if ready
        if (audio.readyState > 0) {
            restorePlayback();
        } else {
            audio.addEventListener('loadedmetadata', restorePlayback);
        }
        // save playback position on time update
        audio.addEventListener('timeupdate', function() {
            localStorage.setItem('weddingAudioTime', audio.currentTime);
        });
        btn.addEventListener('click', function(event) {
            // Prevent body click handler from interfering
            event.stopPropagation();
            var isOn = btn.getAttribute('data-on') === 'true';
            if (isOn) {
                // Turn off
                audio.pause();
                audio.muted = true;
                icon.textContent = 'ðŸ”‡';
                status.textContent = '{% trans "Off" %}';
                btn.setAttribute('data-on', 'false');
                localStorage.setItem('weddingAudioOn', 'false');
            } else {
                // Turn on
                audio.muted = false;
                audio.play().catch(function(){});
                icon.textContent = 'ðŸ”Š';
                status.textContent = '{% trans "On" %}';
                btn.setAttribute('data-on', 'true');
                localStorage.setItem('weddingAudioOn', 'true');
                localStorage.setItem('weddingAudioUnmuted', 'true');
            }
        });
    });
    </script>
</nav>

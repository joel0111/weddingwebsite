{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
<nav class="navbar">
    <div class="navbar-links">
        <a href="{% url 'home' %}" class="nav-link{% if request.resolver_match.url_name == 'home' %} active{% endif %}">{% trans "Home" %}</a>
        <span class="nav-item-wrapper">
            <a href="{% url 'gallery' %}" class="nav-link{% if request.resolver_match.url_name == 'gallery' %} active{% endif %}">{% trans "Gallery" %}</a>
            <span class="coming-soon">{% trans "Coming Soon" %}</span>
        </span>
        <a href="{% url 'rsvp' %}" class="nav-link{% if request.resolver_match.url_name == 'rsvp' %} active{% endif %}">{% trans "RSVP" %}</a>
        <a href="{% url 'volunteer' %}" class="nav-link{% if request.resolver_match.url_name == 'volunteer' %} active{% endif %}">{% trans "Volunteer" %}</a>
        <span style="position:relative;display:inline-block;">
            <a href="{% url 'freebies' %}" class="nav-link{% if request.resolver_match.url_name == 'freebies' %} active{% endif %}">{% trans "Freebies" %}</a>
            <span class="for-you">{% trans "for you!" %}</span>
        </span>
    </div>
    <form action="{% url 'set_language' %}" method="post" class="lang-toggle">
        {% csrf_token %}
        <input name="next" type="hidden" value="{{ request.get_full_path }}">
        <button type="submit" name="language" value="en" class="lang-btn {% if LANGUAGE_CODE == 'en' %}active{% endif %}">EN</button>
        <button type="submit" name="language" value="zh-hans" class="lang-btn {% if LANGUAGE_CODE == 'zh-hans' %}active{% endif %}">ä¸­æ–‡</button>
    </form>
    <button id="speaker-btn" data-on="true" style="background:none; border:none; margin-left:16px; cursor:pointer; font-size:1.1em; display:flex; align-items:center;">
        <span id="speaker-icon" style="font-size:2.5rem;">ðŸ”Š</span>
        <span id="speaker-status" class="nav-link" style="margin-left:8px;">{% trans "On" %}</span>
    </button>
    <audio id="wedding-audio" preload="auto" loop src="/static/Christina%20Perri%20-%20A%20Thousand%20years%20-%20ThePianoGuys.mp3"></audio>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var audio = document.getElementById('wedding-audio');
        var btn = document.getElementById('speaker-btn');
        var icon = document.getElementById('speaker-icon');
        var status = document.getElementById('speaker-status');
        // determine desired play state
        var playOn = localStorage.getItem('weddingAudioOn') !== 'false';
        // pause first to block autoplay
        audio.pause();
        // restore playback position when metadata loaded and then play if needed
        audio.addEventListener('loadedmetadata', function() {
            var savedTime = localStorage.getItem('weddingAudioTime');
            if (savedTime) {
                audio.currentTime = parseFloat(savedTime);
            }
            if (playOn) {
                audio.play().catch(function(){});
            }
        });
        // save playback position on time update
        audio.addEventListener('timeupdate', function() {
            localStorage.setItem('weddingAudioTime', audio.currentTime);
        });
        // load saved state
        var saved = localStorage.getItem('weddingAudioOn');
        if (saved === 'false') {
            btn.setAttribute('data-on', 'false');
            icon.textContent = 'ðŸ”‡';
            status.textContent = '{% trans "Off" %}';
        } else {
            btn.setAttribute('data-on', 'true');
            icon.textContent = 'ðŸ”Š';
            status.textContent = '{% trans "On" %}';
        }
        btn.addEventListener('click', function() {
            if (btn.getAttribute('data-on') === 'true') {
                audio.pause();
                icon.textContent = 'ðŸ”‡';
                status.textContent = '{% trans "Off" %}';
                btn.setAttribute('data-on', 'false');
                localStorage.setItem('weddingAudioOn', 'false');
            } else {
                audio.play().catch(function(){});
                icon.textContent = 'ðŸ”Š';
                status.textContent = '{% trans "On" %}';
                btn.setAttribute('data-on', 'true');
                localStorage.setItem('weddingAudioOn', 'true');
            }
        });
    });
    </script>
</nav>
